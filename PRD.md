# 惡夢驚襲 (Nightmare Assault) - 產品需求文檔 (PRD)

> **版本**: 1.0.0  
> **最後更新**: 2024-12  
> **授權**: Apache 2.0  
> **Repository**: `nightmare-assault`

---

## 目錄

1. [產品概述](#1-產品概述)
2. [目標用戶](#2-目標用戶)
3. [核心遊戲循環](#3-核心遊戲循環)
4. [功能需求](#4-功能需求)
5. [遊戲機制](#5-遊戲機制)
6. [數值系統](#6-數值系統)
7. [模板系統](#7-模板系統)
8. [Prompt 系統](#8-prompt-系統)
9. [介面設計](#9-介面設計)
10. [音效系統](#10-音效系統)
11. [存檔系統](#11-存檔系統)
12. [API 整合](#12-api-整合)
13. [安裝與發布](#13-安裝與發布)
14. [非功能性需求](#14-非功能性需求)
15. [未來規劃](#15-未來規劃)

---

## 1. 產品概述

### 1.1 產品定位

**惡夢驚襲 (Nightmare Assault)** 是一款基於 LLM 的終端文字冒險遊戲，融合「規則怪談」恐怖類型與「海龜湯」推理元素。玩家將扮演被惡夢纏身的主角，在現實中遭遇與夢境相似的恐怖場景，必須透過觀察、推理、發現潛規則來逃出生天。

### 1.2 核心理念

| 理念 | 描述 |
|------|------|
| **夢境預知** | 夢境片段是未來的線索，玩家需要將夢境與現實對應 |
| **潛規則生存** | 遊戲世界有隱藏規則，違反即死，需要透過觀察推理 |
| **無力感恐懼** | 玩家無法用超能力或武力解決問題，只能智取 |
| **公平性原則** | 每次死亡都有可追溯的線索，不是純粹的不講理 |

### 1.3 產品特色

- 🎮 **CLI 跨平台遊戲**：Windows / macOS / Linux 一行指令安裝
- 🤖 **多 LLM 支援**：OpenAI、Anthropic、Gemini、Grok 及各種 Gateway
- 🎭 **動態故事生成**：每次遊戲都是獨特的恐怖體驗
- 🧩 **潛規則系統**：海龜湯式推理，線索散落在對話與環境中
- 😱 **雙數值系統**：生命值與理智值，理智過低會產生幻覺
- 🔊 **沉浸式音效**：BGM 與音效增強恐怖氛圍
- 📖 **失敗覆盤**：死亡後告訴你錯在哪裡，線索在哪裡

### 1.4 支援語言

- 繁體中文 (zh-TW) - 主要
- English (en-US) - 次要

---

## 2. 目標用戶

### 2.1 主要用戶群

| 用戶類型 | 描述 | 需求 |
|----------|------|------|
| 恐怖遊戲愛好者 | 喜歡規則怪談、恐怖解謎 | 高品質的恐怖敘事體驗 |
| 推理遊戲玩家 | 喜歡海龜湯、偵探遊戲 | 有邏輯的線索與推理過程 |
| 終端/CLI 愛好者 | 習慣使用終端工具的開發者 | 純文字但有沉浸感的體驗 |
| AI 互動體驗者 | 對 LLM 遊戲有興趣 | 高自由度的互動與回應 |

### 2.2 年齡分級

| 模式 | 年齡 | 內容限制 |
|------|------|----------|
| 一般模式 | 全年齡 | 無血腥暴力、死亡描述隱晦 |
| 18+ 模式 | 18 歲以上 | 詳細暴力描寫、心理恐怖、髒話 |

**18+ 模式解鎖內容**：
- 詳細的傷口、內臟、骨骼斷裂描寫
- 極端心理恐怖與人性黑暗面
- Body Horror 類型怪物設計
- NPC 使用髒話與激烈語氣
- 更絕望的情節發展

---

## 3. 核心遊戲循環

### 3.1 主循環

```
┌─────────────────────────────────────────────────────────────┐
│                        核心遊戲循環                          │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│    ┌──────────┐     ┌──────────┐     ┌──────────┐          │
│    │  探索     │────▶│ 發現線索  │────▶│  推理    │          │
│    │ Explore  │     │ Discover │     │ Deduce  │          │
│    └──────────┘     └──────────┘     └──────────┘          │
│          ▲                                  │               │
│          │                                  ▼               │
│    ┌──────────┐                      ┌──────────┐          │
│    │  存活     │◀─────────────────────│  行動    │          │
│    │ Survive  │    或                │  Act     │          │
│    └──────────┘                      └──────────┘          │
│          │                                  │               │
│          │         ┌──────────┐            │               │
│          └────────▶│  死亡     │◀───────────┘               │
│                    │  Death   │   (觸發規則)                │
│                    └──────────┘                             │
│                          │                                  │
│                          ▼                                  │
│                    ┌──────────┐                             │
│                    │  覆盤     │                             │
│                    │ Debrief  │                             │
│                    └──────────┘                             │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 遊戲階段

| 階段 | 描述 | 佔比 |
|------|------|------|
| **序章 (Prologue)** | 開場夢境，玩家體驗「預知夢」，可能經歷一次必死場景 | 5-10% |
| **探索期 (Exploration)** | 進入場景，認識隊友，收集初期線索 | 20-30% |
| **緊張期 (Tension)** | 開始發生怪事，規則逐漸顯現，可能有隊友死亡 | 30-40% |
| **高潮期 (Climax)** | 核心真相揭露，生死存亡的抉擇 | 20-25% |
| **結局 (Ending)** | 根據玩家表現，進入不同結局 | 5-10% |

### 3.3 結局類型

| 結局 | 條件 | 描述 |
|------|------|------|
| **完美逃脫** | 全員存活 + 破解核心謎團 | 真正逃出，了解事件真相 |
| **慘勝逃脫** | 主角存活 + 部分隊友死亡 | 逃出但留下陰影 |
| **真相結局** | 發現隱藏的終極真相 | 隱藏結局，需要特定條件 |
| **輪迴結局** | 逃出後發現還在夢中 | 開放式結局 |
| **瘋狂結局** | 理智值歸零 | 主角迷失在夢境中 |
| **死亡結局** | 生命值歸零 / 觸發即死規則 | 遊戲結束 |

---

## 4. 功能需求

### 4.1 功能清單

#### P0 - 核心功能 (Must Have)

| ID | 功能 | 描述 |
|----|------|------|
| F001 | 故事生成 | 根據用戶輸入的主題/大綱生成完整故事架構 |
| F002 | 潛規則系統 | 生成並追蹤隱藏規則，處理觸發邏輯 |
| F003 | 對話互動 | 自由輸入或選擇選項與遊戲互動 |
| F004 | 雙數值系統 | 生命值與理智值的追蹤與效果 |
| F005 | NPC 系統 | 隊友生成、對話、死亡處理 |
| F006 | 存檔/讀檔 | 3 個存檔槽，JSON 格式 |
| F007 | 多 API 支援 | OpenAI、Anthropic、Gemini、Grok、Gateway |
| F008 | 斜線指令 | /status、/inventory、/save 等快捷指令 |
| F009 | 死亡覆盤 | 顯示死因、觸發的規則、錯過的線索 |
| F010 | 跨平台編譯 | Windows、macOS、Linux 單一執行檔 |

#### P1 - 重要功能 (Should Have)

| ID | 功能 | 描述 |
|----|------|------|
| F011 | 夢境系統 | 開場夢境、穿插夢境、夢境回顧 |
| F012 | 章節壓縮 | Token 管理，舊章節自動摘要 |
| F013 | BGM 系統 | 背景音樂播放、場景切換 |
| F014 | 音效系統 | 提示音、警告音、死亡音效 |
| F015 | 理智幻覺 | 低理智時的文字扭曲、幻覺選項 |
| F016 | 主題切換 | 多種終端顏色主題 |
| F017 | 打字機效果 | Stream 輸出，可開關 |
| F018 | 自動更新 | 檢查更新、一鍵更新 |

#### P2 - 增強功能 (Nice to Have)

| ID | 功能 | 描述 |
|----|------|------|
| F019 | 自訂 BGM | 用戶可放入自己的音樂 |
| F020 | 多語言切換 | 遊戲中切換繁中/英文 |
| F021 | 詳細日誌 | /log 查看歷史對話 |
| F022 | 提示系統 | /hint 花費理智獲得提示 |

### 4.2 斜線指令清單

| 指令 | 功能 | 參數 |
|------|------|------|
| `/status` | 查看生命值、理智值、當前狀態 | 無 |
| `/inventory` | 查看背包物品 | 無 |
| `/clues` | 查看已發現的線索 | 無 |
| `/dreams` | 回顧夢境片段 | 無 |
| `/team` | 查看隊友狀態（存活、位置、物品） | 無 |
| `/rules` | 查看已知的規則（不含隱藏規則） | 無 |
| `/save` | 存檔 | `[1-3]` 存檔槽編號 |
| `/load` | 讀檔 | `[1-3]` 存檔槽編號 |
| `/log` | 查看最近的對話紀錄 | `[n]` 顯示筆數 |
| `/hint` | 花費 10 理智值獲得提示 | 無 |
| `/theme` | 切換顯示主題 | `[theme_name]` |
| `/api` | 切換 API 供應商 | 無（互動式選擇） |
| `/bgm` | BGM 控制 | `on/off/volume [0-100]` |
| `/speed` | 打字機效果開關 | `on/off` |
| `/lang` | 切換語言 | `zh-TW/en-US` |
| `/help` | 顯示幫助 | `[command]` |
| `/quit` | 退出遊戲 | 無 |

---

## 5. 遊戲機制

### 5.1 故事生成

#### 輸入參數

| 參數 | 描述 | 限制 |
|------|------|------|
| 故事主題/大綱 | 用戶自由輸入或選擇提示 | 上限 300 tokens |
| 難度 | 簡單 / 困難 / 地獄 | 影響規則數量與線索明確度 |
| 長度 | 短 / 中 / 長 | 影響章節數與故事複雜度 |
| 18+ 模式 | 是否啟用成人內容 | 布林值 |

#### 提示範例（顯示在 UI 中供參考）

```
💡 故事主題提示：
• 廢棄醫院的午夜值班
• 深夜校園的畢業典禮
• 荒野小屋的暴風雨夜
• 午夜公車的末班車
• 自家臥室的平行世界
• 婚禮會場的詛咒新娘
```

### 5.2 難度系統

| 難度 | 潛規則數 | 線索明確度 | 煙霧彈 | 映射層級 | 警告機制 |
|------|----------|------------|--------|----------|----------|
| **簡單** | ≤6 | 直接提示 | 少 | 單重 | 2次警告後死亡 |
| **困難** | 不限 | 隱喻/破碎 | 中等 | 雙重 | 1次警告後死亡 |
| **地獄** | 不限 | 矛盾/誤導 | 大量 | 三重+ | 無警告直接死亡 |

#### 映射層級說明

```
單重映射：線索 A → 規則 X
  例：紙條寫著「別回頭」→ 不能回頭的規則

雙重映射：線索 A → 線索 B → 規則 X
  例：「背後沒有眼睛，但它有」→ 需要理解暗喻 → 不能回頭的規則

三重映射：線索 A → 線索 B → 線索 C → 規則 X
  例：兩個矛盾的線索，需要判斷哪個是真的
```

### 5.3 故事長度

| 長度 | 字數範圍 | 章節數 | 預估遊玩時間 |
|------|----------|--------|--------------|
| **短篇** | 10,000 - 39,999 | 3-5 章 | 30-60 分鐘 |
| **中篇** | 40,000 - 79,999 | 5-8 章 | 1-2 小時 |
| **長篇** | 80,000+ | 8-15 章 | 2-4 小時 |

### 5.4 潛規則系統

#### 規則分類

| 類型 | 描述 | 範例 |
|------|------|------|
| **場景規則** | 只在特定地點生效 | 地下室不能開燈 |
| **時間規則** | 特定時段生效 | 凌晨三點不能說話 |
| **行為規則** | 任何時候都生效 | 不能背對窗戶 |
| **對象規則** | 針對特定 NPC/物品 | 不能直視那個小孩 |
| **狀態規則** | 依賴玩家狀態 | 理智值 < 50 才能看到門 |
| **對立規則** | 兩條看似矛盾的規則 | 紅燈要停，但聽到哭聲要跑 |

#### 規則觸發流程

```
玩家輸入
    │
    ▼
┌─────────────────┐
│ 解析玩家意圖/行為 │
└────────┬────────┘
         │
         ▼
┌─────────────────┐     ┌─────────────────┐
│ 檢查場景規則     │────▶│ 檢查時間規則     │
└────────┬────────┘     └────────┬────────┘
         │                       │
         ▼                       ▼
┌─────────────────┐     ┌─────────────────┐
│ 檢查行為規則     │────▶│ 檢查狀態規則     │
└────────┬────────┘     └────────┬────────┘
         │                       │
         └───────────┬───────────┘
                     │
              ┌──────┴──────┐
              │ 規則違反？   │
              └──────┬──────┘
                     │
         ┌───────────┴───────────┐
         ▼                       ▼
    [是：觸發]              [否：正常]
         │                       │
    ┌────┴────┐                  │
    │輕微/嚴重│                  │
    └────┬────┘                  │
         │                       │
    ┌────┴────┐                  │
    ▼         ▼                  ▼
 [警告]    [即死]           [繼續遊戲]
```

### 5.5 脫軌處理機制

當玩家做出超出預期的行為時：

| 行為類型 | 處理策略 | 範例 |
|----------|----------|------|
| **逃避型** | 軟性阻擋 | 門打不開、路被堵住 |
| **破壞型** | 後果轉化 | 放火→火勢失控引來怪物 |
| **創造型** | 納入+限制 | 自稱道士→咒語變成吸引怪物的頻率 |
| **試探型** | 順勢發展 | 對鬼告白→鬼把你當成替身 |
| **合理型** | 接受+轉折 | 報警→電話傳來自己的聲音 |

**核心原則**：
- 永遠不直接拒絕玩家
- 用世界觀內的邏輯解釋
- 保持無力感是核心體驗
- 玩家的「優勢」會變成「弱點」

---

## 6. 數值系統

### 6.1 理智值 (Sanity / SAN)

| 數值範圍 | 狀態 | 效果 |
|----------|------|------|
| 80-100 | 清醒 | 描述客觀冷靜，觀察敏銳 |
| 50-79 | 焦慮 | 描述出現心跳聲、冷汗，語氣急躁 |
| 20-49 | 恐慌 | 文字扭曲、感官欺騙、關鍵字變紅 |
| 1-19 | 崩潰 | 幻覺選項（陷阱）、強制行為 |
| 0 | 瘋狂 | **遊戲結束** - Bad End |

#### 理智效果詳細說明

**恐慌狀態 (20-49)**：
```
正常文字：「你聽到了遠處的腳步聲。」
扭曲文字：「你聽到了...死...去...的腳步聲。」
感官欺騙：「小美在背後嘟囔著什麼，好像在罵你。」（其實沒有）
```

**崩潰狀態 (1-19)**：
```
幻覺選項範例：
[A] 躲進衣櫃裡
[B] 從窗戶跳出去
[C] 眼前出現一扇發光的門，那是出口！  ← 陷阱（實際是焚化爐）

強制行為範例：
「你突然控制不住自己，尖叫了一聲——」
```

#### 理智值變化

| 事件 | 變化 |
|------|------|
| 目睹隊友死亡 | -15 ~ -25 |
| 遭遇恐怖場景 | -5 ~ -15 |
| 輕微違規警告 | -10 ~ -20 |
| 發現不合理現象 | -5 ~ -10 |
| 成功解謎 | +5 ~ +10 |
| 隊友安慰/深度交流 | +5 ~ +15 |
| 安全區域休息 | +10 ~ +20 |
| 使用鎮靜劑 | +15 ~ +25 |
| 使用護身符 | +10 (一次性) |

#### SAN 緩衝區設計

SAN 不是單一數字，而是一個有「緩衝區」的系統：

| SAN 範圍 | 輸入方式 | 視覺效果 | 心理效果 |
|----------|----------|----------|----------|
| 80-100 | 完整文字輸入 | 清晰界面 | 玩家感覺安全 |
| 60-79 | 偶爾閃爍 | 輕微邊框變化 | 開始警覺 |
| 40-59 | 輸入框縮小 | 明顯邊框顏色變化 | 感覺壓迫 |
| 20-39 | 游標閃爍加速 | 文字扭曲、顏色變暗 | 明顯焦慮 |
| 1-19 | 隨機刪除字元 | 嚴重視覺干擾 | 失控感 |
| 0 | — | 崩潰 | 遊戲結束 |

**設計原則：控制權即理智**
- SAN 不只是數字，是玩家的「控制權」
- 高 SAN：完整控制（打字流暢、選項清晰）
- 低 SAN：失去控制（輸入受阻、選項模糊、幻覺選項）
- 這讓玩家「感受」到理智在消失，而不只是「看到」數字在減少

#### 幻覺選項設計原則

**❌ 錯誤做法：事先標記幻覺選項**
- 標記了就不恐怖了
- 玩家知道是假的就不會選
- 失去對自己感官的懷疑

**✅ 正確做法：事後揭露**

```
【選擇時】
你聽到三個方向的聲音：
[A] 右邊走廊傳來呼救聲
[B] 左邊房間有微弱的光
[C] 身後有腳步聲接近

（沒有任何標記，玩家根據直覺選擇）

【選擇 A 後】
你衝向右邊走廊——
但那裡什麼都沒有。
只有你自己的回音在迴盪。
你意識到，那個聲音從一開始就不存在。

【覆盤時】
💀 選項 A 是幻覺
   原因：你的 SAN 只有 15
   線索：「呼救聲」的描述用了「彷彿」「似乎」等詞
```

**設計哲學**
- ❌ 被欺騙感：「遊戲騙我選假選項」
- ✅ 感官懷疑：「我連自己聽到的都不能相信了」
  → 這才是真正的恐怖體驗

### 6.2 生命值 (Health / HP)

| 數值範圍 | 狀態 | 效果 |
|----------|------|------|
| 70-100 | 健康 | 正常行動 |
| 30-69 | 受傷 | 描述中提及傷口，行動可能受限 |
| 1-29 | 瀕死 | 需要立即治療，某些行動無法執行 |
| 0 | 死亡 | **遊戲結束** |

#### 生命值變化

| 事件 | 變化 |
|------|------|
| 怪物攻擊 | -20 ~ -50 |
| 陷阱觸發 | -15 ~ -30 |
| 跌落/撞擊 | -10 ~ -20 |
| 輕微違規警告 | -10 ~ -15 |
| 使用急救包 | +30 ~ +50 |
| 使用繃帶 | +10 ~ +20 |
| 安全休息 | +5 ~ +10 |

### 6.3 道具系統

| 道具類型 | 範例 | 效果 |
|----------|------|------|
| **治療道具** | 急救包、繃帶、藥品 | 恢復 HP |
| **理智道具** | 鎮靜劑、巧克力、護身符 | 恢復 SAN |
| **線索道具** | 日記、鑰匙、照片 | 推進劇情/揭露規則 |
| **工具道具** | 手電筒、打火機、繩索 | 解謎/探索用 |
| **關鍵道具** | 特定物品 | 影響結局 |

---

## 7. 模板系統

### 7.1 核心恐懼源模板 (The Source)

| ID | 類型 | 描述 | 規則邏輯 | 範例 |
|----|------|------|----------|------|
| S01 | 概念類 | 抽象恐懼的具現化 | 認知觸發 | 被遺忘就會死、看到紅色被標記 |
| S02 | 實體類 | 具體的恐怖存在 | 位置/行為觸發 | 恐怖玩偶、看不見的巡邏者 |
| S03 | 因果類 | 過去事件的重演 | 重現特定行為觸發 | 冤魂索命、慘案重演 |
| S04 | 模因類 | 傳染性的恐懼 | 認知/接觸觸發 | 知道名字就會死、看到就被詛咒 |
| S05 | 空間類 | 空間本身的異常 | 位置/移動觸發 | 無限循環、空間折疊 |

**模板參數結構**：
```json
{
  "source_type": "memetic",
  "trigger": "cognition",
  "weakness": "ignorance",
  "manifestation": "auditory_hallucination"
}
```

### 7.2 場景風格模板 (The Setting)

| ID | 場景類型 | 氛圍關鍵字 | 常見道具 |
|----|----------|------------|----------|
| L01 | 廢棄設施 | 腐朽、寂靜、回聲 | 病歷、生鏽工具、輪椅 |
| L02 | 封閉空間 | 壓迫、幽閉、窒息 | 手機、鏡子、按鈕 |
| L03 | 開放荒野 | 孤獨、迷失、無助 | 指南針、營火、路牌 |
| L04 | 日常空間 | 違和、熟悉又陌生 | 家具、照片、窗戶 |
| L05 | 交通工具 | 移動、無法逃離 | 座位、窗戶、廣播 |

**違和感道具設計**：
- 沙漠中運作的冰箱
- 廢棄醫院裡新鮮的花束
- 午夜公車上的兒童玩具

### 7.3 潛規則邏輯模板 (Rule Templates)

#### 基礎模板

| ID | 模板類型 | 結構 | 範例 |
|----|----------|------|------|
| R01 | 禁止型 | 不能 [動作] 當 [條件] | 聽到鐘聲時不能移動 |
| R02 | 強制型 | 必須 [動作] 當 [條件] | 看到紅燈必須停下 |
| R03 | 條件型 | 只有 [狀態] 才能 [動作] | 閉眼才能通過走廊 |
| R04 | 對象型 | 對 [對象] 不能 [動作] | 不能直視小女孩的眼睛 |

#### 進階模板

| ID | 模板類型 | 描述 | 範例 |
|----|----------|------|------|
| R05 | 對立型 | 兩條看似矛盾的規則 | 明文：紅燈要停；隱藏：聽到哭聲時紅燈要跑 |
| R06 | 認知污染型 | 感知變化即為線索 | 覺得隊友說話變慢了→立刻摀住耳朵 |
| R07 | 狀態依賴型 | 根據數值改變規則 | SAN<50 能看到門；SAN<20 門變成怪物 |
| R08 | 時空映射型 | 夢境與現實的對應 | 夢中 3AM 的敲門聲→現實 3PM 不能開門 |
| R09 | 計數型 | 累積觸發 | 第三次回頭時死亡 |
| R10 | 連鎖型 | 觸發後改變其他規則 | 打破鏡子後，所有反射面都變危險 |

### 7.4 NPC 原型模板 (Archetypes)

| ID | 原型 | 功能 | 特徵 | 物品傾向 |
|----|------|------|------|----------|
| N01 | 犧牲者 | 演示錯誤規則 | 衝動、不聽勸 | 無用道具 |
| N02 | 不可靠敘述者 | 煙霧彈來源 | 神秘、矛盾 | 誤導性線索 |
| N03 | 理性分析者 | 高準確度線索 | 冷靜、邏輯 | 筆記、工具 |
| N04 | 直覺敏銳者 | 感覺提示 | 敏感、緊張 | 護身符 |
| N05 | 隱藏知情者 | 知道但不能說 | 欲言又止 | 關鍵道具 |
| N06 | 被附身者 | 規則的一部分 | 行為異常 | 危險道具 |

#### NPC 介紹設計原則

**❌ 避免：RPG 角色卡**
```
【小明加入隊伍】
姓名：陳小明
年齡：24 歲
職業：研究生
特長：化學知識、冷靜分析
→ 問題：像在讀說明書，打破沉浸感
```

**✅ 使用：行為展示 (Show, Don't Tell)**

| 方法 | 範例 |
|------|------|
| 主角記憶 | 「你想起大一那年，他連鬼屋都不敢進...」 |
| 行動展示 | 小美從髮間抽出髮夾，幾秒後鎖開了 |
| 對話揭示 | 「還記得畢業旅行嗎？那個下雨天...」 |
| 物品觸發 | 手機螢幕亮起，一個小女孩的照片 |
| 他人評價 | 「小明那傢伙...我不信任他。」 |

#### NPC 介紹原則

| 原則 | 說明 |
|------|------|
| Show, Don't Tell | 用行動/對話展示，不用說明文字 |
| 逐步揭露 | 分散在多個場景，不要一次全講 |
| 先建立羈絆 | 讓玩家在乎角色，再讓角色面臨危險 |
| 每個人有秘密 | 可被發現的秘密增加探索動機 |
| 關係網絡 | NPC 之間的關係也要設計 |

#### NPC 死亡情緒設計

**設計核心：「這是我的錯」而非「這是劇本殺」**

| 玩家反應 | 判斷標準 |
|----------|----------|
| 「如果我選 A 就好了」 | ✅ 成功設計 |
| 「遊戲不讓我救他」 | ❌ 失敗設計 |
| 「這是我的責任」 | ✅ 玩家產生愧疚 |
| 「反正是 NPC」 | ❌ 玩家沒有投入 |

**可預防死亡三階段架構**

1. **伏筆（前置章節）**：牆上寫著「聽到名字，別回應」
2. **預警（事件前）**：給玩家選擇 [A]阻止 [B]觀察 [C]鼓勵
3. **後果分歧**：不同選擇導致不同結果

**大部分隊友死亡應該是可預防的**
- 玩家有機會做出正確選擇
- 正確選擇能改變結果
- 死亡是玩家選擇的後果，不是強制劇情

### 7.5 故事結構模板

| ID | 結構類型 | 勝利條件 | 核心謎團 |
|----|----------|----------|----------|
| T01 | 逃脫型 | 找到出口並離開 | 出口在哪裡 |
| T02 | 生存型 | 撐到特定時間 | 如何活過這段時間 |
| T03 | 解謎型 | 揭開真相 | 發生了什麼事 |
| T04 | 驅魔型 | 消滅/封印威脅 | 威脅的弱點是什麼 |
| T05 | 輪迴型 | 打破循環 | 為什麼會重複 |

### 7.6 玩法模板庫 (Gameplay Templates)

| 模板 ID | 名稱 | 核心機制 | 玩家目標 | 失敗條件 |
|---------|------|----------|----------|----------|
| P01 | 規則生存 | 發現並遵守隱藏規則 | 推理出規則 | 違反規則 |
| P02 | 限時逃脫 | 倒數計時內逃出 | 找到出口 | 時間耗盡 |
| P03 | 追逐躲藏 | 被不可阻擋的東西追趕 | 躲藏或逃跑 | 被抓到 |
| P04 | 資源管理 | 有限的燈光/藥品/理智 | 撐到終點 | 資源耗盡 |
| P05 | 社交推理 | 找出誰是威脅/叛徒 | 識別並處理 | 信錯人 |
| P06 | 認知污染 | 知識有代價 | 選擇性獲取資訊 | 知道太多 |
| P07 | 循環突破 | 困在時間/空間循環 | 找到打破方法 | 無限循環 |
| P08 | 儀式完成 | 收集物品/完成步驟 | 執行儀式 | 步驟錯誤 |
| P09 | 護送保護 | 保護無法自保的人 | 讓目標存活 | 目標死亡 |
| P10 | 抉擇困境 | 無法兩全的選擇 | 做出選擇 | 逃避選擇 |

### 7.7 場景模板庫 (Setting Templates)

| 模板 ID | 名稱 | 空間特性 | 適合的玩法 |
|---------|------|----------|------------|
| S01 | 廢棄醫院 | 多房間、長走廊 | 探索、規則、追逐 |
| S02 | 困住的電梯 | 極度封閉 | 社交、資源、抉擇 |
| S03 | 深夜校園 | 熟悉又陌生 | 規則、循環、儀式 |
| S04 | 迷霧森林 | 無邊界、迷失感 | 追逐、資源、護送 |
| S05 | 老舊公寓 | 垂直結構、鄰居 | 社交、規則、認知 |
| S06 | 末班列車 | 線性移動、車廂分隔 | 限時、規則、社交 |
| S07 | 地下隧道 | 黑暗、分岔路 | 追逐、資源、探索 |
| S08 | 鏡像空間 | 現實扭曲 | 認知、循環、規則 |
| S09 | 宴會大廳 | 開放但被包圍 | 社交、儀式、抉擇 |
| S10 | 自己的家 | 最熟悉的地方 | 認知、入侵、規則 |

### 7.8 恐懼源模板庫 (Fear Source Templates)

| 模板 ID | 名稱 | 恐懼本質 | 能被打敗嗎 |
|---------|------|----------|------------|
| F01 | 規則實體 | 執行規則的存在 | 遵守規則即可 |
| F02 | 不可視獵手 | 看不見但在追你 | 只能躲 |
| F03 | 認知寄生 | 想法本身是威脅 | 不要想它 |
| F04 | 熟人偽裝 | 身邊的人不是本人 | 識別並隔離 |
| F05 | 空間扭曲 | 環境本身在變化 | 找到錨點 |
| F06 | 時間異常 | 困在時間裡 | 打破循環 |
| F07 | 集體意識 | 人群本身是威脅 | 逃離或融入 |
| F08 | 自我分裂 | 自己的一部分是敵人 | 整合或切割 |
| F09 | 宇宙存在 | 不可理解的高維 | 無法打敗 |
| F10 | 因果逆轉 | 結果先於原因 | 接受並利用 |

### 7.9 區塊連接規則

#### 連接類型

| 類型 | 說明 | 範例 |
|------|------|------|
| 線性 | A → B → C | 章節式推進 |
| 分支 | A → B1 或 B2 | 選擇導致不同路線 |
| 匯合 | B1/B2 → C | 不同路徑殊途同歸 |
| 循環 | A → B → C → A | 時間循環 |
| 嵌套 | A[B]A | 夢中夢、回憶 |

#### 區塊轉換觸發

| 觸發類型 | 條件 | 效果 |
|----------|------|------|
| 劇情觸發 | 完成目標 | 進入下一區塊 |
| 時間觸發 | 回合數/遊戲時間 | 強制轉換 |
| 狀態觸發 | HP/SAN 達到閾值 | 特殊區塊（如夢境） |
| 選擇觸發 | 關鍵選擇 | 分支路線 |
| 失敗觸發 | 區塊失敗 | 進入懲罰區塊 |

#### 模板組合規則

| 規則 | 說明 |
|------|------|
| 節奏平衡 | 高壓區塊後接喘息區塊 |
| 玩法輪替 | 避免連續相同玩法 |
| 恐懼遞進 | 從可理解到不可理解 |
| NPC 連貫 | 隊友狀態跨區塊追蹤 |
| 線索串聯 | 前區塊的線索在後區塊驗證 |

### 7.10 區塊結構定義

```json
{
  "block_id": "B001",
  "block_name": "廢棄醫院：禁忌病房",

  "templates": {
    "gameplay": "P01_rule_survival",
    "setting": "S01_abandoned_hospital",
    "fear_source": "F01_rule_entity"
  },

  "parameters": {
    "duration": "medium",
    "difficulty_modifier": 1.0,
    "san_pressure": "gradual",
    "npc_count": 2
  },

  "rules": [
    {
      "id": "R001",
      "text": "不要直視病床上的東西",
      "hints": ["夢境暗示", "牆上塗鴉", "NPC死亡示範"],
      "severity": "lethal"
    }
  ],

  "entry_conditions": {
    "from_blocks": ["B000_prologue"],
    "required_items": [],
    "required_flags": ["found_hospital_key"]
  },

  "exit_conditions": [
    {
      "type": "success",
      "condition": "reach_exit",
      "next_block": "B002"
    },
    {
      "type": "branch",
      "condition": "discover_secret",
      "next_block": "B002_hidden"
    },
    {
      "type": "failure",
      "condition": "death",
      "next_block": "death_screen"
    }
  ]
}
```

### 7.11 動態組合範例

#### 範例故事：《最後一班列車》

| 區塊 | 玩法 | 場景 | 恐懼源 | 重點 |
|------|------|------|--------|------|
| 序章 | 循環突破 | 月台 | 時間異常 | 建立世界觀 |
| 第一章 | 規則生存 | 列車車廂 | 規則實體 | 學習核心玩法 |
| 第二章 | 社交推理 | 餐車 | 熟人偽裝 | NPC 有人被附身 |
| 第三章 | 追逐躲藏 | 貨物車廂 | 不可視獵手 | 節奏轉換 |
| 第四章 | 抉擇困境 | 駕駛室 | 因果逆轉 | 高潮 |
| 結局 | — | — | — | 多結局分歧 |

#### 範例故事：《鏡中校園》

| 區塊 | 玩法 | 場景 | 恐懼源 | 重點 |
|------|------|------|--------|------|
| 序章 | 認知污染 | 鏡像空間 | 自我分裂 | 鏡中自己不一樣 |
| 第一章 | 規則生存 | 深夜校園 | 規則實體 | 鏡子有規則 |
| 第二章 | 儀式完成 | 教室 | 認知寄生 | 收集碎片 |
| 第三章 | 護送保護 | 走廊 | 不可視獵手 | 保護另一個自己 |
| 第四章 | 循環突破 | 校門 | 時間異常 | 打破鏡像 |

### 7.12 LLM 區塊生成指令

讓 AI 根據模板生成內容：

```
STORY GENERATION CONTEXT:

Current Block: B002
- Gameplay: P03_chase_escape (追逐躲藏)
- Setting: S07_underground_tunnel (地下隧道)
- Fear Source: F02_invisible_hunter (不可視獵手)

Block Parameters:
- Duration: short (3-5 interactions)
- SAN Pressure: high (constant drain)
- Available NPCs: 小美 (alive), 小明 (dead)

Player State:
- HP: 65, SAN: 40
- Known Rules: [R001, R002]
- Inventory: [手電筒, 地圖碎片]

Generate: Opening narration for this block
Tone: Urgent, claustrophobic, hunted
Must Include: Sound-based horror, limited visibility
```

---

## 8. Prompt 系統

### 8.1 雙層 Prompt 架構

```
┌─────────────────────────────────────────────────────────────┐
│                      System Prompt                          │
│  ┌───────────────────────────────────────────────────────┐ │
│  │ • 遊戲規則與機制                                        │ │
│  │ • 輸出格式規範 (JSON/XML 標籤)                         │ │
│  │ • 18+ 內容開關                                         │ │
│  │ • 語言設定                                             │ │
│  └───────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│                      Game Bible (Hidden)                    │
│  ┌───────────────────────────────────────────────────────┐ │
│  │ • 故事種子 (story_seed)                                │ │
│  │ • 核心真相 (truth)                                     │ │
│  │ • 所有潛規則 (rules[])                                 │ │
│  │ • 隊友設定 (teammates[])                               │ │
│  │ • 夢境片段 (dreams[])                                  │ │
│  └───────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│                      Dynamic Context                        │
│  ┌───────────────────────────────────────────────────────┐ │
│  │ • 當前狀態 (HP/SAN/位置/物品)                          │ │
│  │ • 已發現線索                                           │ │
│  │ • 已知規則                                             │ │
│  │ • 隊友狀態                                             │ │
│  │ • 章節摘要                                             │ │
│  │ • 最近對話 (10 輪)                                     │ │
│  └───────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### 8.2 Game Bible 結構

```json
{
  "meta": {
    "story_seed": "深夜校園 + 鏡子怪談",
    "difficulty": "hard",
    "target_length": "medium",
    "is_adult": true
  },
  "truth": {
    "core_mystery": "主角其實已經在夢裡死了，現在是在尋找替身",
    "true_ending_condition": "在鏡中看到真正的自己並接受",
    "hidden_ending_condition": "讓所有鏡子都破碎"
  },
  "rules": [
    {
      "id": 1,
      "text": "聽到鐘聲必須停下腳步",
      "trigger_location": "走廊",
      "trigger_condition": "player_moving AND bell_sound",
      "is_fake": false,
      "severity": "lethal",
      "hints_planned": [
        {"chapter": 1, "type": "dream", "content": "夢中你在奔跑，鐘聲響起，然後你跌入深淵"},
        {"chapter": 2, "type": "npc_death", "content": "小明沒有停下，他的身體像玻璃一樣碎裂"}
      ],
      "death_message": "你沒有停下，鐘聲震碎了你的耳膜，隨後是你的頭骨..."
    },
    {
      "id": 2,
      "text": "校警是可以信任的",
      "is_fake": true,
      "clue_to_debunk": "校警的制服是反著穿的（夢境特徵）"
    }
  ],
  "teammates": [
    {
      "id": 1,
      "name": "小美",
      "archetype": "unreliable_narrator",
      "personality": "神秘、說話模糊",
      "role_in_story": "煙霧彈來源",
      "items": ["破碎的鏡子"],
      "secret": "她其實是鬼的一部分",
      "is_alive": true
    }
  ],
  "dreams": [
    {
      "id": 1,
      "trigger": "prologue",
      "content": "你站在無盡的走廊中，鐘聲響起，你的腳卻無法停下...",
      "related_rule_id": 1,
      "clarity": 0.3
    }
  ],
  "hidden_states": {
    "ghost_anger": 0,
    "ritual_progress": 0,
    "time_loops": 0
  }
}
```

### 8.3 輸出格式規範

AI 輸出必須包含結構化標籤，供程式解析：

```xml
<story>
你緩緩推開那扇紅色的門，鏽蝕的門軸發出刺耳的尖叫。
門後是一條漫長的走廊，盡頭的黑暗彷彿會吞噬一切光線。
小美站在你身後，聲音有些顫抖：「我們...真的要進去嗎？」
</story>

<options>
A. 「跟緊我，別落單。」
B. 「妳在這裡等著，我先去探路。」
C. 「算了，我們找別的路。」
D. [自由輸入]
</options>

<data>
{
  "hp_change": 0,
  "san_change": -5,
  "location": "corridor_entrance",
  "items_found": [],
  "clues_found": ["走廊盡頭有微弱的紅光"],
  "rules_triggered": [],
  "npc_status": {"小美": "nervous"},
  "bgm": "tension",
  "sfx": ["door_creak"]
}
</data>
```

### 8.4 難度 Prompt 調整

**簡單模式**：
```
Generate direct hints for rules. When a player is about to violate a rule, 
give an obvious warning through NPC dialogue or environmental description.
Clues should directly point to the rule (single mapping).
```

**困難模式**：
```
Generate metaphorical hints. Clues should be fragmented poetry or symbolic descriptions.
Use double mapping: Clue A → Clue B → Rule X.
Include 30% smoke screen clues that lead nowhere.
```

**地獄模式**：
```
Generate contradictory clues. Create two clues: one from a dead teammate's diary (true), 
one from a distorted radio broadcast (false). Player must deduce which is real.
Use triple mapping. Include 50% smoke screen clues.
Some "helpful" NPCs are actually lying.
```

### 8.5 脫軌處理 Prompt

```
IMPROVISATION CONSTRAINTS:
When player attempts to introduce external abilities (magic, superpowers) that break horror atmosphere:
1. NEVER directly refuse. Instead, TWIST it into nightmare logic.
2. Example: Player chants a spell → "You speak the incantation, but in this space, 
   your voice transforms into a frequency that ATTRACTS the creatures... 
   The shadows grow more excited."
3. CORE PRINCIPLE: Maintain the sense of helplessness. 
   Player's perceived "advantages" must become "vulnerabilities".
4. Any "power" gained must have severe limitations or drawbacks.
```

### 8.6 章節壓縮策略

```
MEMORY COMPRESSION RULES:
When context exceeds 70% of token limit, compress previous chapters.

MUST PRESERVE:
- Character survival status
- Discovered clues (verbatim)
- Known rules (verbatim)  
- Current inventory
- Current objective
- Hidden states (ghost_anger, ritual_progress)
- Player-added settings (e.g., "I am a Taoist priest")
- Key dialogue that may become foreshadowing

CAN COMPRESS:
- Atmospheric descriptions
- Routine NPC dialogue
- Failed exploration attempts
- Combat details (keep only outcome)

COMPRESSION FORMAT:
"[Chapter 2 Summary: Team entered basement. Found rusty key. 
小明 died (violated Rule #3: spoke during silence). 
Clue discovered: 'The clock stops at 3:33'. Current objective: Find the red door.]"
```

### 8.7 LLM Characterization Rules

```
CHARACTERIZATION RULES:

1. NEVER use stat blocks or character sheets
   - No "特長：xxx" or "性格：xxx" exposition
   - Reveal traits through observable behavior

2. Show personality through action and dialogue
   - Nervous character: describes fidgeting, hesitation
   - Brave character: acts first, questions later
   - Smart character: notices details others miss

3. Use protagonist's memories for backstory
   - "你想起..." format to reveal shared history
   - Memories triggered by locations, objects, or dialogue
   - Unreliable memories at low SAN

4. Every character has a discoverable secret
   - Secrets create exploration incentive
   - Some secrets affect survival
   - Not all secrets are revealed in one playthrough

5. Make player CARE before character can die
   - Establish emotional connection first
   - Minimum 2-3 positive interactions before death risk
   - Death of stranger ≠ death of friend
```

### 8.8 情緒設計指令

```
EMOTION DESIGN RULES:

Primary Target Emotions:
- 恐懼 (Fear): 想繼續但不敢
- 緊張 (Tension): 時刻保持注意
- 好奇 (Curiosity): 想知道更多
- 成就感 (Achievement): 我真聰明
- 想再來一次 (Replayability): 這次我一定行

Avoid These Negative Emotions:
- 沮喪 (Frustration): 不公平的死亡導致
- 焦慮 (Anxiety): 資訊過載導致
- 無聊 (Boredom): 重複內容導致
- 僥倖 (Lucky guess): 選項無差異導致
- 被欺負 (Bullied): 遊戲惡意設計導致

Micro-Emotion Guidelines:
- 恐懼 vs 沮喪: 留有線索 vs 無預警殺人
- 緊張 vs 焦慮: 規則清晰 vs 規則太多
- 成就 vs 僥倖: 選擇有邏輯 vs 選項無差異
- 失控 vs 被欺負: 有預警 vs 突然改變規則
```

---

## 9. 介面設計

### 9.1 主選單

```
┌─────────────────────────────────────────────────────────────────┐
│                                                                  │
│     ███╗   ██╗██╗ ██████╗ ██╗  ██╗████████╗███╗   ███╗          │
│     ████╗  ██║██║██╔════╝ ██║  ██║╚══██╔══╝████╗ ████║          │
│     ██╔██╗ ██║██║██║  ███╗███████║   ██║   ██╔████╔██║          │
│     ██║╚██╗██║██║██║   ██║██╔══██║   ██║   ██║╚██╔╝██║          │
│     ██║ ╚████║██║╚██████╔╝██║  ██║   ██║   ██║ ╚═╝ ██║          │
│     ╚═╝  ╚═══╝╚═╝ ╚═════╝ ╚═╝  ╚═╝   ╚═╝   ╚═╝     ╚═╝          │
│                    █████╗ ███████╗███████╗ █████╗ ██╗   ██╗     │
│                   ██╔══██╗██╔════╝██╔════╝██╔══██╗██║   ██║     │
│                   ███████║███████╗███████╗███████║██║   ██║     │
│                   ██╔══██║╚════██║╚════██║██╔══██║██║   ██║     │
│                   ██║  ██║███████║███████║██║  ██║╚██████╔╝     │
│                   ╚═╝  ╚═╝╚══════╝╚══════╝╚═╝  ╚═╝ ╚═════╝      │
│                                                                  │
│                        惡  夢  驚  襲                            │
│                                                                  │
│                    [1] 新遊戲  New Game                          │
│                    [2] 繼續遊戲  Continue                        │
│                    [3] 設定  Settings                            │
│                    [4] 離開  Exit                                │
│                                                                  │
│                                                 v1.0.0           │
└─────────────────────────────────────────────────────────────────┘
```

### 9.2 遊戲主畫面

```
┌─────────────────────────────────────────────────────────────────┐
│ HP [████████░░] 80    SAN [██████░░░░] 55    📍 廢棄走廊        │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  --- 第 2 章：深淵的回聲 ---                                    │
│                                                                  │
│  你緩緩推開那扇紅色的門，鏽蝕的門軸發出刺耳的尖叫。             │
│  門後是一條漫長的走廊，盡頭的黑暗彷彿會吞噬一切光線。           │
│                                                                  │
│  走廊兩側是無數緊閉的房門，每扇門上都有一個生鏽的號碼牌。       │
│  你注意到牆上有一行字，用暗紅色的東西寫成：                     │
│                                                                  │
│      「數到三，別回頭。」                                        │
│                                                                  │
│  小美站在你身後，聲音有些顫抖：「這是什麼意思...？」            │
│                                                                  │
├─────────────────────────────────────────────────────────────────┤
│  [A] 「可能是某種警告，我們小心點。」                           │
│  [B] 「別管它，繼續走。」                                       │
│  [C] 仔細檢查這行字的筆跡                                       │
│  [D] 回頭看看來時的路                                           │
│  [_] _________________________________ (自由輸入)               │
├─────────────────────────────────────────────────────────────────┤
│  /help 幫助 | /status 狀態 | /inventory 背包 | /save 存檔       │
└─────────────────────────────────────────────────────────────────┘
```

### 9.3 低理智狀態畫面 (SAN < 40)

```
┌─────────────────────────────────────────────────────────────────┐
│ HP [████████░░] 80    SAN [██░░░░░░░░] 18    📍 ??? 走廊 ???    │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  --- 第 ?̷ 章：深̸淵̷的̴回̵聲̸ ---                                │
│                                                                  │
│  牆壁在呼吸。你確定牆壁在呼吸。                                  │
│                                                                  │
│  小美...不...那是小美嗎？她的臉為什麼有那麼多眼睛？             │
│  「沒事的...沒事的...沒事的...」她的聲音像是壞掉的唱片。         │
│                                                                  │
│  你感覺頭痛欲裂，視野邊緣開始出現黑色的蟲子在蠕動。             │
│  它們來了它們來了它們來了它們來了                                │
│                                                                  │
│  走廊盡頭，有一扇發著溫暖金光的門。那一定是出口。               │
│  （一定是的。一定是的。一定是的。）                             │
│                                                                  │
├─────────────────────────────────────────────────────────────────┤
│  [A] 跑向那扇發光的門（看起來很安全）     ← [⚠️ 幻覺選項]       │
│  [B] 蹲下來，抱住頭，什麼都不做                                 │
│  [C] 把它們的皮剝下來                      ← [⚠️ 幻覺選項]       │
│  [D] 吃掉鎮靜劑                                                 │
│  [_] ░░░░░░ 你的手抖得無法打字... ░░░░░░  ← [已封鎖]            │
├─────────────────────────────────────────────────────────────────┤
│  ⚠️ 理智值過低，無法自由輸入                                    │
└─────────────────────────────────────────────────────────────────┘
```

### 9.4 死亡畫面

```
┌─────────────────────────────────────────────────────────────────┐
│                                                                  │
│  ██████████████████████████████████████████████████████████████  │
│  ██████████████████████████████████████████████████████████████  │
│                                                                  │
│                        ██╗   ██╗ ██████╗ ██╗   ██╗               │
│                        ╚██╗ ██╔╝██╔═══██╗██║   ██║               │
│                         ╚████╔╝ ██║   ██║██║   ██║               │
│                          ╚██╔╝  ██║   ██║██║   ██║               │
│                           ██║   ╚██████╔╝╚██████╔╝               │
│                           ╚═╝    ╚═════╝  ╚═════╝                │
│                                                                  │
│                          ██████╗ ██╗███████╗██████╗              │
│                          ██╔══██╗██║██╔════╝██╔══██╗             │
│                          ██║  ██║██║█████╗  ██║  ██║             │
│                          ██║  ██║██║██╔══╝  ██║  ██║             │
│                          ██████╔╝██║███████╗██████╔╝             │
│                          ╚═════╝ ╚═╝╚══════╝╚═════╝              │
│                                                                  │
│  ──────────────────────────────────────────────────────────────  │
│                                                                  │
│  你沒有停下腳步。                                                │
│  鐘聲震碎了你的耳膜，隨後是你的頭骨...                          │
│                                                                  │
│  ──────────────────────────────────────────────────────────────  │
│                                                                  │
│              [1] 查看死因分析 (View Death Analysis)              │
│              [2] 讀取最後存檔 (Load Last Save)                   │
│              [3] 返回主選單 (Return to Menu)                     │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 9.5 覆盤畫面

```
┌─────────────────────────────────────────────────────────────────┐
│                         死 因 分 析                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ⚰️ 死亡原因：違反規則 #1                                       │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ 規則 #1：聽到鐘聲時必須停下腳步                          │    │
│  │ 觸發位置：走廊                                           │    │
│  │ 嚴重程度：即死                                           │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  📍 線索回顧：                                                   │
│                                                                  │
│  [第 1 章 - 夢境] ✓ 已給出                                      │
│   「夢中你在奔跑，鐘聲響起，然後你跌入深淵...」                 │
│                                                                  │
│  [第 2 章 - NPC 死亡] ✓ 已給出                                  │
│   「小明沒有停下，他的身體像玻璃一樣碎裂」                      │
│                                                                  │
│  [第 2 章 - 牆上文字] ✓ 已給出                                  │
│   「數到三，別回頭。停下腳步。」                                │
│                                                                  │
│  ──────────────────────────────────────────────────────────────  │
│                                                                  │
│  💡 分析：你在第 2 章時已經獲得了足夠的線索。                   │
│     小明的死亡是一個明顯的警告。                                │
│                                                                  │
│  📊 遊玩統計：                                                   │
│     存活時間：45 分鐘                                           │
│     發現線索：7/12                                               │
│     破解規則：2/6                                                │
│     隊友存活：1/4                                                │
│                                                                  │
│              [Enter] 繼續                                        │
└─────────────────────────────────────────────────────────────────┘
```

### 9.6 顏色主題

| 主題名稱 | 背景色 | 前景色 | 強調色 | 警告色 | 適用情境 |
|----------|--------|--------|--------|--------|----------|
| `midnight` | #1a1a2e | #eaeaea | #e94560 | #ff6b6b | 預設深色主題 |
| `blood` | #1a0000 | #ff9999 | #ff0000 | #ffff00 | SAN < 40 強制切換 |
| `asylum` | #0d1117 | #c9d1d9 | #58a6ff | #f85149 | 醫院/精神病院場景 |
| `forest` | #0d1f0d | #98c379 | #61afef | #e06c75 | 森林/野外場景 |
| `terminal` | #000000 | #00ff00 | #00ffff | #ff0000 | 復古終端風格 |

**SAN 強制變色機制**：
- SAN < 40：關鍵字變紅色
- SAN < 20：強制切換到 `blood` 主題（背景可由用戶覆蓋）

---

## 10. 音效系統

### 10.1 BGM 配置

| ID | 場景 | 檔案名稱 | 描述 |
|----|------|----------|------|
| BGM01 | 探索 | `ambient_explore.mp3` | 平靜但詭異的環境音 |
| BGM02 | 緊張 | `tension_building.mp3` | 漸強的懸疑氛圍 |
| BGM03 | 追逐 | `chase_horror.mp3` | 高壓、急促的追逐音樂 |
| BGM04 | 悲傷 | `melancholy.mp3` | 隊友死亡、回憶場景 |
| BGM05 | 安全 | `safe_room.mp3` | 短暫的休息區域 |
| BGM06 | 結局 | `ending_theme.mp3` | 結局場景 |

### 10.2 音效配置

| ID | 類型 | 檔案名稱 | 觸發時機 |
|----|------|----------|----------|
| SFX01 | 系統 | `key_press.wav` | 玩家輸入確認 |
| SFX02 | 系統 | `option_select.wav` | 選擇選項 |
| SFX03 | 警告 | `warning.wav` | 規則警告、危險提示 |
| SFX04 | 死亡 | `death.wav` | 玩家/NPC 死亡 |
| SFX05 | 發現 | `clue_found.wav` | 發現線索 |
| SFX06 | 恐怖 | `heartbeat.wav` | 緊張場景、低 SAN |
| SFX07 | 恐怖 | `scream.wav` | 恐怖事件 |
| SFX08 | 恐怖 | `footsteps.wav` | 有東西靠近 |
| SFX09 | 恐怖 | `door_creak.wav` | 開門 |
| SFX10 | 恐怖 | `whisper.wav` | 低 SAN 幻聽 |

### 10.3 音效觸發機制

音效由 LLM 在輸出中指定：

```xml
<data>
{
  "bgm": "tension",
  "sfx": ["door_creak", "footsteps"]
}
</data>
```

程式端解析後調用 `oto` 庫播放。

### 10.4 自訂 BGM

用戶可將自訂音樂放入 `~/.nightmare/bgm/custom/`：
- 檔案命名：`custom_[場景].mp3`（如 `custom_chase.mp3`）
- 系統優先讀取自訂檔案

---

## 11. 存檔系統

### 11.1 存檔結構

```json
{
  "meta": {
    "save_id": 1,
    "save_name": "存檔 1",
    "created_at": "2024-12-01T15:30:00Z",
    "updated_at": "2024-12-01T16:45:00Z",
    "playtime_seconds": 2700,
    "game_version": "1.0.0"
  },
  "settings": {
    "difficulty": "hard",
    "target_length": "medium",
    "is_adult": true,
    "language": "zh-TW"
  },
  "story": {
    "seed": "深夜校園的畢業典禮",
    "title": "最後的鐘聲",
    "current_chapter": 3,
    "chapter_summaries": [
      "[Ch1] 開場夢境，看到鐘聲與奔跑...",
      "[Ch2] 進入校園，小明死亡，發現規則 #1..."
    ],
    "truth": "...",
    "ending_flags": {}
  },
  "rules": {
    "all_rules": [...],
    "known_rules": [1],
    "triggered_rules": [1],
    "warnings_received": []
  },
  "player": {
    "hp": 75,
    "san": 55,
    "location": "school_corridor_2f",
    "inventory": [
      {"id": "rusty_key", "name": "生鏽的鑰匙", "description": "..."},
      {"id": "flashlight", "name": "手電筒", "description": "..."}
    ],
    "known_clues": [
      {"id": 1, "content": "鐘聲響起時必須停下", "source": "dream"},
      {"id": 2, "content": "紅色的門後有東西", "source": "wall_writing"}
    ],
    "player_settings": {
      "claimed_profession": null,
      "special_abilities": []
    }
  },
  "teammates": [
    {
      "id": 1,
      "name": "小美",
      "is_alive": true,
      "hp": 80,
      "san": 45,
      "location": "school_corridor_2f",
      "items": ["broken_mirror"],
      "trust_level": 70,
      "known_info": ["知道地下室有密道"]
    },
    {
      "id": 2,
      "name": "小明",
      "is_alive": false,
      "death_chapter": 2,
      "death_cause": "violated_rule_1"
    }
  ],
  "dreams": {
    "fragments": [
      {"id": 1, "content": "...", "is_matched": true, "matched_at": "chapter_2"}
    ]
  },
  "hidden_states": {
    "ghost_anger": 30,
    "ritual_progress": 0,
    "time_loops": 0,
    "turn_count": 45,
    "in_game_time": "02:30"
  },
  "conversation": {
    "full_history": [...],
    "compressed_history": "..."
  },
  "api_usage": {
    "total_tokens": 125000,
    "smart_model_tokens": 100000,
    "fast_model_tokens": 25000
  }
}
```

### 11.2 存檔槽

- 最多 **3 個存檔槽**
- 存檔位置：`~/.nightmare/saves/`
- 檔案命名：`save_1.json`、`save_2.json`、`save_3.json`

### 11.3 存檔操作

| 操作 | 指令 | 說明 |
|------|------|------|
| 存檔 | `/save [1-3]` | 儲存到指定槽位 |
| 讀檔 | `/load [1-3]` | 讀取指定槽位 |
| 查看存檔 | `/save list` | 列出所有存檔資訊 |
| 刪除存檔 | `/save delete [1-3]` | 刪除指定存檔 |

---

## 12. API 整合

### 12.1 雙模型架構

```
┌─────────────────────────────────────────────────────────────────┐
│                       雙模型分工架構                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                 Smart Model (高智商)                     │    │
│  │                    地下城主 (DM)                         │    │
│  │                                                          │    │
│  │  職責：                                                  │    │
│  │  • 故事敘述 (Narrative)                                  │    │
│  │  • 恐怖場景渲染                                          │    │
│  │  • 伏筆鋪設與回收                                        │    │
│  │  • 規則觸發判定                                          │    │
│  │  • 玩家意圖的複雜推理                                    │    │
│  │                                                          │    │
│  │  推薦模型：                                              │    │
│  │  • Claude 3.5 Sonnet (文筆最佳)                          │    │
│  │  • GPT-4o (速度與智能平衡)                               │    │
│  │  • Claude 3 Opus (最聰明)                                │    │
│  └─────────────────────────────────────────────────────────┘    │
│                              │                                   │
│                              ▼                                   │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                 Fast Model (低延遲)                      │    │
│  │              數據分析師 / 氣氛組 / 路由員                 │    │
│  │                                                          │    │
│  │  職責：                                                  │    │
│  │  • 狀態更新 (Story → JSON)                               │    │
│  │  • 隊友插話 (掩蓋延遲)                                   │    │
│  │  • 意圖識別 (快速路由)                                   │    │
│  │  • 垃圾輸入過濾                                          │    │
│  │                                                          │    │
│  │  推薦模型：                                              │    │
│  │  • Llama-3-70B via Groq (極速)                           │    │
│  │  • GPT-4o-mini (便宜快速)                                │    │
│  │  • Claude 3 Haiku (快速)                                 │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 12.2 模型分工詳細

| 任務類型 | 使用模型 | 角色 | 原因 |
|----------|----------|------|------|
| 故事敘述 | Smart | 地下城主 (DM) | 需要處理伏筆、氛圍渲染、邏輯一致性 |
| 狀態更新 | Fast | 數據分析師 | 將文學內容轉為 JSON，小模型擅長 |
| 隊友吐槽 | Fast | 氣氛組 | 填補 Smart Model 的等待時間 |
| 意圖識別 | Fast | 路由員 | 快速判斷玩家意圖，攔截無效指令 |
| 規則判定 | Smart | DM | 複雜的海龜湯規則需要高智商 |
| 章節摘要 | Fast | 壓縮器 | 摘要任務小模型即可勝任 |

### 12.3 延遲掩蓋策略

```
玩家按下 Enter
        │
        ▼ (0ms)
┌─────────────────────┐
│ 播放按鍵音效        │
│ 顯示轉場文字        │ ← 本地即時響應
│ "你屏住呼吸..."     │
└──────────┬──────────┘
           │
           ▼ (100ms)
┌─────────────────────┐     ┌─────────────────────┐
│ Fast Model 請求      │     │ Smart Model 請求    │
│ "生成隊友反應"       │     │ "生成恐怖場景"       │
└──────────┬──────────┘     └──────────┬──────────┘
           │                            │
           ▼ (300ms)                    │
┌─────────────────────┐                 │
│ 隊友插話顯示        │                 │
│ "小心！前面有聲音！" │ ← 掩蓋延遲      │
└──────────┬──────────┘                 │
           │                            │
           │ (玩家閱讀隊友對話...)       │
           │                            ▼ (2000ms)
           │                 ┌─────────────────────┐
           │                 │ 恐怖場景串流輸出    │
           │                 │ (打字機效果)        │
           │                 └──────────┬──────────┘
           │                            │
           ▼                            ▼
┌─────────────────────────────────────────────────┐
│                 Fast Model                       │
│        解析故事 → 生成狀態更新 JSON              │
└─────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────┐
│ 更新 UI (HP/SAN)    │
│ 顯示選項            │
└─────────────────────┘
```

### 12.4 API 配置結構

```json
{
  "api": {
    "smart_model": {
      "provider": "anthropic",
      "base_url": "https://api.anthropic.com/v1",
      "api_key": "sk-ant-...",
      "model": "claude-3-5-sonnet-20241022",
      "max_tokens": 4096,
      "temperature": 0.8
    },
    "fast_model": {
      "provider": "groq",
      "base_url": "https://api.groq.com/openai/v1",
      "api_key": "gsk-...",
      "model": "llama-3.1-70b-versatile",
      "max_tokens": 2048,
      "temperature": 0.5
    }
  }
}
```

### 12.5 支援的 API 供應商

| 供應商 | Base URL | 說明 |
|--------|----------|------|
| OpenAI | `https://api.openai.com/v1` | 官方 API |
| Anthropic | `https://api.anthropic.com/v1` | Claude 系列 |
| Google | `https://generativelanguage.googleapis.com/v1beta` | Gemini 系列 |
| Groq | `https://api.groq.com/openai/v1` | 超高速推理 |
| xAI | `https://api.x.ai/v1` | Grok 系列 |
| OpenRouter | `https://openrouter.ai/api/v1` | 多模型網關 |
| Together | `https://api.together.xyz/v1` | 開源模型 |
| 自訂 | 任意 URL | 兼容 OpenAI 格式即可 |

### 12.6 Token 管理

| 情境 | 處理方式 |
|------|----------|
| 接近上限 (70%) | 觸發章節壓縮 |
| 達到上限 (90%) | 警告用戶，建議切換 API 或壓縮 |
| 超過上限 | 強制壓縮最舊章節，或提示無法繼續 |
| Smart Model 超限 | 提示用戶，可切換到更大上下文模型 |
| Fast Model 超限 | 自動切換任務到 Smart Model |

### 12.7 錯誤處理

| 錯誤類型 | 重試次數 | 處理方式 |
|----------|----------|----------|
| 網路錯誤 | 5 次 | 指數退避重試 |
| API 限流 | 3 次 | 等待後重試，或切換備用 |
| 無效回應 | 3 次 | 重新請求 |
| Token 超限 | 0 次 | 提示用戶，執行壓縮 |
| API Key 無效 | 0 次 | 提示用戶更新 Key |

---

## 13. 安裝與發布

### 13.1 安裝指令

**Windows (PowerShell)**：
```powershell
irm https://nightmare-assault.dev/install.ps1 | iex
```

**macOS / Linux**：
```bash
curl -fsSL https://nightmare-assault.dev/install.sh | sh
```

### 13.2 安裝目錄結構

```
~/.nightmare/
├── bin/
│   └── nightmare(.exe)      # 主程式
├── config/
│   └── config.json          # 用戶配置
├── saves/
│   ├── save_1.json          # 存檔 1
│   ├── save_2.json          # 存檔 2
│   └── save_3.json          # 存檔 3
├── bgm/
│   ├── ambient_explore.mp3  # 內建 BGM
│   ├── tension_building.mp3
│   ├── ...
│   └── custom/              # 自訂 BGM 目錄
├── sfx/
│   ├── key_press.wav        # 內建音效
│   ├── warning.wav
│   └── ...
├── skills/                   # Skill 定義檔（可自訂）
│   ├── story_generation.md
│   ├── rule_generation.md
│   └── ...
├── transitions/
│   └── transitions.json      # 轉場文字庫
├── logs/
│   └── game.log             # 遊戲日誌
└── version.txt              # 當前版本
```

### 13.3 編譯目標

| 平台 | 架構 | 檔案名稱 |
|------|------|----------|
| Windows | amd64 | `nightmare-windows-amd64.exe` |
| Windows | arm64 | `nightmare-windows-arm64.exe` |
| macOS | amd64 | `nightmare-darwin-amd64` |
| macOS | arm64 | `nightmare-darwin-arm64` |
| Linux | amd64 | `nightmare-linux-amd64` |
| Linux | arm64 | `nightmare-linux-arm64` |

### 13.4 更新機制

```
nightmare update --check   # 檢查更新
nightmare update           # 執行更新
nightmare version          # 顯示版本
```

更新流程：
1. 查詢 GitHub Releases API 獲取最新版本
2. 比較版本號
3. 顯示更新日誌
4. 下載新版本
5. 驗證 checksum
6. 替換舊版本
7. 保留用戶配置與存檔

---

## 14. 非功能性需求

### 14.1 性能需求

| 指標 | 目標 |
|------|------|
| 啟動時間 | < 2 秒 |
| 選項響應時間 (本地) | < 100ms |
| 轉場文字顯示 | < 200ms |
| 隊友插話生成 (Fast Model) | < 500ms |
| 故事生成 (Smart Model) | < 5 秒 (串流開始) |
| 存檔/讀檔 | < 500ms |
| 記憶體使用 | < 200MB (不含音訊) |

### 14.2 安全需求

| 項目 | 要求 |
|------|------|
| API Key 儲存 | 本地加密儲存，不上傳 |
| 存檔資料 | 僅本地儲存 |
| 網路請求 | 僅與 LLM API 通訊 |
| 遙測數據 | 不收集任何數據 |
| 更新驗證 | 使用 checksum 驗證 |

### 14.3 可用性需求

| 項目 | 要求 |
|------|------|
| 離線遊玩 | 不支援（需要 LLM API） |
| 網路中斷 | 自動重試，提示用戶 |
| 終端相容性 | 支援 256 色終端 |
| 最小終端大小 | 80x24 |
| 鍵盤操作 | 完全支援純鍵盤操作 |

### 14.4 可維護性需求

| 項目 | 要求 |
|------|------|
| 日誌記錄 | 可選的 debug 日誌 |
| 錯誤報告 | 友善的錯誤訊息 |
| 配置熱重載 | 支援修改配置後不重啟 |
| Skill 自訂 | 用戶可修改 Skill 定義檔 |

---

## 15. 未來規劃

### 15.1 版本路線圖

| 版本 | 預計功能 | 優先級 |
|------|----------|--------|
| **v1.0** | 核心遊戲循環、單人遊戲、基礎音效 | P0 |
| **v1.1** | 更多故事模板、成就系統、統計數據 | P1 |
| **v1.2** | 遊戲內教學、新手引導、更多主題 | P1 |
| **v2.0** | 多人合作模式（共享存檔、同步遊戲） | P2 |
| **v2.1** | 社群故事分享、種子碼系統 | P2 |
| **v3.0** | 視覺小說模式（配合 AI 生成圖片） | P3 |

### 15.2 多人模式設計預覽

- 2-4 人合作
- 每人控制一名角色
- 私密頻道（只有特定玩家能看到的訊息）
- 背叛機制（某個玩家可能被附身）
- 投票系統（決定團隊行動）

### 15.3 社群功能預覽

- 故事種子碼分享
- 社群創作的規則模板
- 排行榜（最快通關、最高存活率）
- 死亡集錦回放

---

## 附錄

### A. 術語表

| 術語 | 英文 | 定義 |
|------|------|------|
| 潛規則 | Hidden Rule | 遊戲世界的隱藏規則，違反即觸發懲罰 |
| 理智值 | Sanity (SAN) | 角色的心理健康程度 |
| 生命值 | Health (HP) | 角色的身體健康程度 |
| 夢境片段 | Dream Fragment | 預知未來的夢境線索 |
| 覆盤 | Debrief | 死亡後的分析與回顧 |
| 映射 | Mapping | 線索到規則的推理層級 |
| 煙霧彈 | Smoke Screen | 誤導性的假線索 |
| 轉場文字 | Transition Text | 填補 API 延遲的本地文字 |
| Game Bible | - | AI 隱藏的遊戲設定檔 |

### B. 參考資料

- [規則怪談維基](https://zh.wikipedia.org/wiki/規則怪談)
- [海龜湯遊戲規則](https://zh.wikipedia.org/wiki/情境猜謎)
- [克蘇魯的呼喚 TRPG 理智值系統](https://en.wikipedia.org/wiki/Call_of_Cthulhu_(role-playing_game))
- [Bubble Tea TUI 框架](https://github.com/charmbracelet/bubbletea)
- [oto 音訊庫](https://github.com/hajimehoshi/oto)

---

**文檔結束**

*惡夢驚襲 - 願你在夢中找到生路*